酒とゲームとインフラとGCP 第10回　〜祝令和たまには目黒で飲んじゃうぞ@Akatsuki
-----

### 概要

* 日時: 令和元年(2019年)5月14日（火）19:30〜22:30 (開場19:00 完全撤収23:00)
* 住所 東京都品川区上大崎2-13-30 oak meguro 8階 アカツキさん
* https://connpass.com/event/128275/
* #GCP https://twitter.com/search?q=%23GCP
* #酒ゲー https://twitter.com/hashtag/%E9%85%92%E3%82%B2%E3%83%BC?src=hash

-----

### 乾杯とGCP事例ご紹介 by アカツキ坂尾さん

* https://twitter.com/sachaos
* (すみません、途中からです)
* カナリアインストール
    * APIは正しくても組み合わせとか負荷でエラーが出る
* 多段カナリアインストール
    * 1% -> 10% -> 50% -> 100% とすることでAPI -> 組み合わせ -> NW -> 本稼働
* min_instanceを上げる
* pushタスクキューを利用しログを非同期送信
* 1キューあたり300/sec、これを80キュー用意して24000/sec送れるようにする
* pushは送れなくても自動再送信できる
* 処理する先をキューに指定する
* GAEなどGCPサーバレス

-----

### Global Gaming Update by Micah Bakerさん

* MicahさんはGCPのなかでゲームに特化いたGMです
* 最近グーグルはゲームに力を入れている
* Micahさんはゲームに特化した物を作っている
* フォーカスしているのはゲームのなかではオープンソースを活用、どこでも動かせる
* ひとつはアゴネス、クバネテス上にインスタンスを立てる
* この二つは手始めでこれからも色々なオープンソースのアプリが作動するようにする
* デモのなかでゲームにおける機械学習も扱う
* オートMLは機械学習の知識なしでも機械学習が使える
* MicahさんはGoogle Next東京7月に来日予定

### Agonesの最新デモ by Mark Mandelさん

* (ここからGCP開発者後半編)
* Markさんはアゴネスの開発者です
* みんなが一つのサーバに繋がるゲームを想定しています(判定をサーバで行う)
* ゲームサーバをどこに置くか決められる
* このパターンはチートを防げ、レイテンシーが安定している
* マッチメイカーを用意してサーバマネージャーにどのサーバに繋げるか尋ねる
* その後たくさんあるサーバの一つを選び同じゲームの人は同じサーバにつなげる
* サーバマネージャーは自前で作っていたが、そこを用意するのがアゴネス
* ubisoftと共に1年間開発した
* クバネテスを使うことでエンジニアの学習コストを軽減
* あなたはクバネテスで動くサーバを用意するだけ
* 現状のサポート言語はC++, Go, Node.js …

#### ここから本当にデモ

* まずはサーバを200台立てる -> 2分ほどで200台立ち上がる
* 開発にはオープンソースのFPSを使っている
* BOT相手にトラックパッドでは無理ですね
* サーバをいくつかアロケートしサーバ数を0にする
* アロケートした物は終了から保護される
    * 例えばゲーム終了するまでサーバを維持するが、新規接続はしない
* 綴りはagones、今年中にバージョン1.0になる
* テスト用にGCPのマーケットプレイスにアゴネスがある
* agonesのステッカーどうぞ！

-----

### 休憩
* レコードのファイナルファンタジーサントラ？
* またSpannerのマネージャーも来日しているので挨拶いたします
* 次のSpannerの話楽しみにしています

-----

### GCP事例ご紹介(GAE + Spanner) by アニプレックス 宮崎さん

* ハイスクール・フリート 艦隊バトルでピンチ
* いつもの酒ゲーの雰囲気からしたら明るいなと
* アニプレックスについて
    * 基本はアニメ・映像・音楽の制作販売する会社
    * ソシャゲは基本的に外注
    * ただしサーバソフトは一部内製したい、と言うわけで私はサーバ制作部門
* ソフト制作の一部を内政しているなかのプロジェクト
* プロジェクト開発当初エンジニアは2人でインフラに人を費やしたくない
* Spannerはインフラに手がかからないDBとして採用
* ゲームのマスターデータはGoogleスプレッドシートにしている
    * 複数人で書き換えられるのがポイント
* 当然agonesとか使ってないのでマッチング等は内製
    * 最後1ヶ月で炎上したが今日はやらない(のでagones研究するといいよ)
* スタックドライバ最高
* GAEを使った時の利点
    * Blue-Greenデプロイが簡単にできる
    * トラフィック分割でのカナリアリリースも簡単
    * ゲーム本編・ガチャ…とサーバを分けて切り戻しも簡単
    * オートスケールもとても簡単
    * Stackdriver Monitoringに基本メトリクスが書き込まれているので、ダッシュボードとアラート程度の設定だけで手間がかからない
* フレキシブル環境の難点
    * デプロイに5分かかる…
* 2genでスタンダード環境でもメモリストアにアクセスできるようになったので作り替えたい
* GAEは非常に安定している、インフラそのものは安くないが人件費が丸ごと浮くのが大きい
* SpannerはCPU使用率監視で75%超えたらノードを増やす程度
    * 学習コストは高くない
    * リージョナルなら10ms以下(某RDBには勝てない)
    * シャーディングを考えなくて良いので楽
* ここからちょっとネガティブな話
    * レプリカが無いのは少々辛い
        * ヘビーなクエリ実行時に安全なノードがない -> ビッククエリーにインポート
    * エミュレータが無いのが痛い -> 1インスタンス月額8万円
        * 開発用は個人用を含めて共有
* RDBになれている人が戸惑うこと
    * セカンダリインデックスを考えて作る
        * スコアなど初期値が固定の物でソート用インデックスを作ると危険
    * データ容量が少ないとスループットが上がらない -> 予め適当なデータを書いておく
        * 負荷試験時のデータを運営開始3日前に削除したら1日延びてGCでこのデータが削除されてしまった
            * これからやる人は前日にしよう
    * テーブルをJOINする順番が大切
* 運用したときのプレッシャーがないのでメリットが大きい

-----

### ミカエルさんによる機械学習のセッション

* ゲームでは広告・課金など機械学習の利用価値は大きい
* チートの検知では将来活用が期待されている
* またライフタイムバリューの価値を予想
* 2100万人の開発者に対してデータサイエンティストは100万人もいないし、コアなデータサイエンティストは1000人以下である
* 元となるデータは数字・時間・画像…
* オートMLは最もふさわしい機械学習モデルを検知して適用する
* サーバレスでトレーニング・プロダクション・モデル制作ができる
* また料金も使った分だけ

#### パイソン ノートブックによる一般的なデータサイエンティストの仕事

* いくつかの少量データによる計算結果で使えそうな物を選択する
* その後いくつかのテンサーフローのコードを書いてテストする
* 満足したらパッケージしてデプロイする
* アプリはAPIを叩いて機械学習の結果を得る

#### ここからオートMLがどれだけ簡単か示すデモ

* とあるゲームでマップ毎の最適武器を算出する
* まずオートMLのプロジェクトを作成
* ビッククエリーからデータを読み込む
* 少し待つ -> 3分クッキング的に結果を出す
* クエリーのうち予測したい要素を選ぶ(ここでは武器)
* キーに対して相関関係が得られる(たとえばマップは0.75)
* 2つの予想モデルを作ってみた、8項目使ったら予測率は97%、このときの計算は1時間
* API化してデプロイ
* ゲームモード、マップ等入力して欲しい物が提示される(今回は8つ)
* 今回の入力では98%マシンガンがおすすめです
* 8つの項目に対して決定の貢献度が表示される(マップが45%、ゲームタイプが35%、プレイ時間の影響は少ない)
* 2要素で予測したら83%の精度になった

-----

### 今後の活動について by TOPGATE 加藤さん

* 酒ゲー歴史と今後の活動について 〜祝 礼和〜
* TOPGATE は2年連続グーグルクラウドアワード受賞
* 2015年の師走に「GCPをゲームで使って欲しい」
* 第1回はイベント名称(の順番)が違った
* 第2回で重要な順に並べたら今のイベント名称になった(GCPが短縮)
* 場所も4カ所ご提供いただきました、次はあなたの所で？ (提供者募集！)
* GCP にご興味持った方は TOPGATE まで！

-----
